<!doctype html>

<html lang="en-us">

<head>
  <title>Multi-staged GitHub Pipeline - somethingAzure</title>
  <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="description" content="somethingAzure a blog on tinkering in Azure" />
<meta name="author" content="Bas van de Sande" /><meta property="og:title" content="Multi-staged GitHub Pipeline" />
<meta property="og:description" content="At the moment I&rsquo;m working on some infrastructure pipelines to build and deploy Azure infrastructure for one of our clients. For me a cool project as I&rsquo;m learning to work with technologies such as Bicep and GitHub actions." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://blog.somethingAzure.com/posts/mutistage-gh-pipeline/" /><meta property="og:image" content="https://blog.somethingAzure.com/multistage/tough-octocat.png" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-09-11T19:46:30+02:00" />
<meta property="article:modified_time" content="2021-09-11T19:46:30+02:00" />


<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://blog.somethingAzure.com/multistage/tough-octocat.png"/>

<meta name="twitter:title" content="Multi-staged GitHub Pipeline"/>
<meta name="twitter:description" content="At the moment I&rsquo;m working on some infrastructure pipelines to build and deploy Azure infrastructure for one of our clients. For me a cool project as I&rsquo;m learning to work with technologies such as Bicep and GitHub actions."/>

<meta name="generator" content="Hugo 0.88.1" />
    
    <link rel="shortcut icon" href="img/favicon.ico" />
  

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css" integrity="sha256-l85OmPOjvil/SOvVt3HnSSjzF1TUMyT9eV0c2BzEGzU=" crossorigin="anonymous" />
  <link rel="stylesheet" href="https://blog.somethingAzure.com/fontawesome/css/all.min.css" />
  
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto+Slab|Ruda" />
  
  
  <link rel="stylesheet" type="text/css" href="/css/styles.css" /></head>

<body>
  <div id="container">
    <header>
      
      <h1>
                <a href="/"><img src="/img/banner.png" class="image-clean" alt="blog.somethingAzure.com" /></a>
            </h1>

      <ul id="social-media">
             <li>
               <a href="https://twitter.com/basvandesande" title="Twitter">
               <i class="fab fa-twitter fa-lg"></i>
               </a>
             </li>
             <li>
               <a href="https://linkedin.com/in/basvandesande" title="LinkedIn">
               <i class="fab fa-linkedin fa-lg"></i>
               </a>
             </li>
             <li>
               <a href="https://github.com/basvandesande" title="GitHub">
               <i class="fab fa-github fa-lg"></i>
               </a>
             </li>
             <li>
               <a href="mailto:bas@vd-sande.nl" title="Email me">
               <i class="fas fa-envelope fa-lg"></i>
               </a>
             </li>
             <li>
               <a href="/index.xml" title="RSS">
               <i class="fas fa-rss fa-lg"></i>
               </a>
             </li>
      </ul>
      
      <p><em>Tinkering in the cloud&hellip;</em></p>
      
    </header>

    
<nav>
    <ul>
        
        <li>
            <a class="" href="/">
                <i class="fa-li fa  fa-lg"></i><span>Home</span>
            </a>
        </li>
        
        <li>
            <a class="" href="/categories">
                <i class="fa-li fa  fa-lg"></i><span>Categories</span>
            </a>
        </li>
        
        <li>
            <a class="" href="/tags">
                <i class="fa-li fa  fa-lg"></i><span>Tags</span>
            </a>
        </li>
        
    </ul>
</nav>


    <main>




<article>

    <h1>Multi-staged GitHub Pipeline</h1>

    
      <aside>
    <ul>
        <li>
            <time class="post-date" datetime="2021-09-11T19:46:30&#43;02:00">Sep 11, 2021</time>
        </li>
        
        
        <li>
            Categories:
            <em>
                
                    
                    <a href="/categories/technical">technical</a>
                
            </em>
        </li>
        

        
        <li>
            <em>
                
                    
                    <a href="/tags/github">#github</a>
                
                    , 
                    <a href="/tags/workaround">#workaround</a>
                
                    , 
                    <a href="/tags/teams">#teams</a>
                
            </em>
        </li>
        

        <li>3 minute read</li>
    </ul>
</aside>

    

    
<div class="featured_image">
    <a href="https://blog.somethingAzure.com/posts/mutistage-gh-pipeline/" title="Multi-staged GitHub Pipeline">
        <img src="/multistage/tough-octocat.png">
    </a>
</div>



    <p>At the moment I&rsquo;m working on some infrastructure pipelines to build and deploy Azure infrastructure for one of our clients. For me a cool project as I&rsquo;m learning to work with technologies such as Bicep and GitHub actions. In this project we use GitHub actions for the CI/CD process. In this process every time a pull request is merged in the main branch, an automated build, test and deployment process is triggered.</p>
<p><img src="/multistage/ms1.png" alt="#multistage"></p>
<p>In this project we have three environments:</p>
<ul>
<li>test
the deployment to this environment should be automatically after each build and merge into main.</li>
<li>acceptance
the deployment to this environment should only take place after an approval.</li>
<li>production
the deployment to this environment should only take place after an approval.</li>
</ul>
<p>Unfortunately, the stage approvals are only part of the enterprise license, and not of the paid team license we use. I was slightly disappointed and during last weekend I got this little idea&hellip;</p>
<p><strong>How about simulating the approval process?</strong></p>
<p>GitHub actions supports &ldquo;Inputs&rdquo;. Inputs are values that have to be set when triggering a workflow. In case a worklow is triggered automatically, the default values are being used. In case the workflow is triggered manually, the user is presented with a popup dialog in which the user has to fill in the values.</p>
<p>This gives the user the option to deploy a build to other environments as well. In the example below, I have the option to either deploy to the acceptance and/or production environment; once the build and deploy to test succeeded.</p>
<p><img src="/multistage/ms3.png" alt="#multistage"></p>
<p>However  In the flow presented above, you cannot deploy to production if you don&rsquo;t deploy to acceptance. To overcome this issue, the yaml needs to be altered, that the deployment for both the acceptance and deployment stage depend on a succeeding deployment in the test environment.</p>
<p><img src="/multistage/ms2.png" alt="#multistage"></p>
<p>To do this, the yaml script has to be setup like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yml" data-lang="yml">
<span style="color:#f92672">name</span>: <span style="color:#ae81ff">my multi staged hub infra deployment</span>

<span style="color:#75715e"># Set environment variables that are being used in the workflows</span>
<span style="color:#f92672">env</span>:
  <span style="color:#f92672">LOCATION</span>: <span style="color:#ae81ff">WestEurope</span>
  <span style="color:#f92672">CLI_VERSION</span>: <span style="color:#ae81ff">2.21.0</span>

<span style="color:#f92672">on</span>:
  <span style="color:#f92672">push</span>:
    <span style="color:#f92672">branches</span>: [ <span style="color:#ae81ff">master ]</span>
    <span style="color:#f92672">paths</span>:
    - <span style="color:#e6db74">&#39;Infra/Modules/**&#39;</span>
    - <span style="color:#e6db74">&#39;Infra/Deployments/hub/**&#39;</span>
    - <span style="color:#e6db74">&#39;.github/workflows/hub.yml&#39;</span>
  <span style="color:#75715e"># Allows you to run this workflow manually from the Actions tab</span>
  <span style="color:#f92672">workflow_dispatch</span>:
    <span style="color:#f92672">inputs</span>:
      <span style="color:#f92672">acceptance</span>:
        <span style="color:#f92672">description</span>: <span style="color:#e6db74">&#39;Deploy to Acceptance (yes/no)?&#39;</span>
        <span style="color:#f92672">required</span>: <span style="color:#66d9ef">true</span>
        <span style="color:#f92672">default</span>: <span style="color:#e6db74">&#39;no&#39;</span>
      <span style="color:#f92672">production</span>:
        <span style="color:#f92672">description</span>: <span style="color:#e6db74">&#39;Deploy to production (yes/no)?&#39;</span>
        <span style="color:#f92672">required</span>: <span style="color:#66d9ef">true</span>
        <span style="color:#f92672">default</span>: <span style="color:#e6db74">&#39;no&#39;</span>
<span style="color:#f92672">jobs</span>:
  <span style="color:#f92672">build-hub</span>:
    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Build Hub</span>
    <span style="color:#f92672">if</span>: <span style="color:#ae81ff">github.event_name == &#39;push&#39; || (github.event_name == &#39;pull_request&#39; &amp;&amp; github.event.action != &#39;closed&#39;) || github.event_name == &#39;repository_dispatch&#39; || github.event_name == &#39;workflow_dispatch&#39;</span>

    <span style="color:#f92672">runs-on</span>: <span style="color:#ae81ff">ubuntu-latest</span>
    <span style="color:#f92672">steps</span>:
      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Checkout files</span>
        <span style="color:#f92672">uses</span>: <span style="color:#ae81ff">actions/checkout@v2</span>
 
      <span style="color:#ae81ff">...</span>

  <span style="color:#f92672">test-provision-hub</span>:
    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">TEST - Provision Hub</span>
    <span style="color:#f92672">needs</span>: <span style="color:#ae81ff">build-hub</span>
    <span style="color:#f92672">runs-on</span>: <span style="color:#ae81ff">ubuntu-latest</span>
    <span style="color:#f92672">steps</span>:
      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Download artifacts</span>
        <span style="color:#f92672">uses</span>: <span style="color:#ae81ff">actions/download-artifact@v2</span>
        <span style="color:#f92672">with</span>:
          <span style="color:#f92672">name</span>: <span style="color:#ae81ff">drop</span>
          <span style="color:#f92672">path</span>: <span style="color:#ae81ff">src</span>
  
     <span style="color:#ae81ff">...</span>

  <span style="color:#f92672">acc-provision-hub</span>:
    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">ACC - Provision Hub </span>
    <span style="color:#f92672">if</span>: <span style="color:#ae81ff">github.event.inputs.acceptance == &#39;yes&#39;</span>
    <span style="color:#f92672">environment</span>: <span style="color:#ae81ff">acc  </span> <span style="color:#75715e"># defined environment with protection rules added</span>
    <span style="color:#f92672">needs</span>: <span style="color:#ae81ff">test-provision-hub</span>
    <span style="color:#f92672">runs-on</span>: <span style="color:#ae81ff">ubuntu-latest</span>
    <span style="color:#f92672">steps</span>:
      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Download artifacts</span>
        <span style="color:#f92672">uses</span>: <span style="color:#ae81ff">actions/download-artifact@v2</span>
        <span style="color:#f92672">with</span>:
          <span style="color:#f92672">name</span>: <span style="color:#ae81ff">drop</span>
          <span style="color:#f92672">path</span>: <span style="color:#ae81ff">src</span>
  
      <span style="color:#ae81ff">...</span>

  <span style="color:#f92672">prod-provision-hub</span>:
    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">PROD - Provision Hub </span>
    <span style="color:#f92672">if</span>: <span style="color:#ae81ff">github.event.inputs.production == &#39;yes&#39;</span>
    <span style="color:#f92672">environment</span>: <span style="color:#ae81ff">prod </span> <span style="color:#75715e"># defined environment with protection rules added</span>
    <span style="color:#f92672">needs</span>: <span style="color:#ae81ff">test-provision-hub</span>
    <span style="color:#f92672">runs-on</span>: <span style="color:#ae81ff">ubuntu-latest</span>
    <span style="color:#f92672">steps</span>:
      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Download artifacts</span>
        <span style="color:#f92672">uses</span>: <span style="color:#ae81ff">actions/download-artifact@v2</span>
        <span style="color:#f92672">with</span>:
          <span style="color:#f92672">name</span>: <span style="color:#ae81ff">drop</span>
          <span style="color:#f92672">path</span>: <span style="color:#ae81ff">src</span>
  
      <span style="color:#ae81ff">...</span>

</code></pre></div><p>For now this workaround will do fine, however I&rsquo;m not so happy with the omission of the multi stage approval in the GitHub Teams subscription. For that reason I contacted a GitHub representative and had a little chat with him. He told me that the focus within GitHub is the Enterprise edition. He advised me to contact GitHub support for this matter. I guess that is going to be my next step.</p>


</article>


<section class="post-nav">
    <ul>
        
        <li>
            <a href="https://blog.somethingAzure.com/posts/certification-renewal/"><i class="fa fa-chevron-circle-left"></i> Certification Renewal</a>
        </li>
        
        
    </ul>
</section>
  
    
    
        <section class="comments-block">
      <button id="show-comments" style="display: none;"><i class="fa fa-comments"></i> Add/View Comments</button>
</section>

<section id="disqus_thread"></section>

<script>
      (function () {
            
            
            if (window.location.hostname == "localhost")
                  return;

            var disqus_loaded = false;
            var disqus_shortname = 'somethingAzure';
            var disqus_button = document.getElementById("show-comments");

            var disqus_autoload =  null ;
            var disable_comment =  null ;

            if (disable_comment)
                  return;

            disqus_button.style.display = "";

            if (disqus_autoload){
                  disqus();
            }else{
                  disqus_button.addEventListener("click", disqus, false);
            }

            function disqus() {

                  if (!disqus_loaded) {
                        disqus_loaded = true;

                        var e = document.createElement("script");
                        e.type = "text/javascript";
                        e.async = true;
                        e.src = "//" + disqus_shortname + ".disqus.com/embed.js";
                        (document.getElementsByTagName("head")[0] ||
                              document.getElementsByTagName("body")[0])
                        .appendChild(e);

                        
                        document.getElementById("show-comments").style.display = "none";
                  }
            }

            
            var hash = window.location.hash.substr(1);
            if (hash.length > 8) {
                  if (hash.substring(0, 8) == "comment-") {
                        disqus();
                  }
            }

            
            if (/bot|google|baidu|bing|msn|duckduckgo|slurp|yandex/i.test(navigator.userAgent)) {
                  disqus();
            }
      })();
</script>

    
  





</main>
    <footer>
        <h6><font class="accent"> Copyright © 2021 - Bas van de Sande </font> |
            <a href="https://blog.somethingAzure.com/">blog.somethingAzure.com</a></h6>
    </footer>
</div>
<script src="/js/scripts.js"></script>


</body>

</html>

